(function(n,t){typeof define=="function"&&define.amd?define(["q"],t):typeof exports=="object"?module.exports=t(require("q")):n.o=t(n.Q)})(this,function(n){function t(n){function i(){for(var i={},n=0,r=arguments.length,t;n<r;n++)for(t in arguments[n])arguments[n].hasOwnProperty(t)&&(i[t]=arguments[n][t]);return i}var t=this;return t.oConfig=t.oConfig||{endpoint:null,format:"json",version:4,strictMode:!0,start:null,ready:null,error:null,headers:[],username:null,password:null,isAsync:!0,isCors:!0,openAjaxRequests:0,isHashRoute:!0,appending:""},t.config=function(n){t.oConfig=i(t.oConfig,n)},t.isEndpoint=function(){return t.oConfig.endpoint!==null},typeof n=="undefined"?t:new r(n,t.oConfig)}function r(t,r){function ht(){var t;return typeof n!="undefined"?n:typeof window=="undefined"?require("q"):null}function ct(n,t,r,u){if(it(t)){var f=[];for(i=0;i<t.length;++i)f[i]="("+n+" "+r+" "+t[i][n]+")";return f.join(" "+u+" ")}return""}function gt(n,t,i){var r,u,f;i=i||(oConfig.version==4?"contains":"substringof");var e=t.split(" "),s=i==="contains"||i==="substringof",o=[];for(r=0;r<n.length;r++){if(u=[],s)for(f=0;f<e.length;f++)oConfig.version==4?u.push(i+"("+n[r]+",'"+e[f]+"')"):u.push(i+"('"+e[f]+"',"+n[r]+")");else u.push(n[r]+" "+i+" '"+t+"'");o.push("("+u.join(" and ")+")")}return o.join("or")}function a(n){var t=n||f,r,i;for(t&&t.path.length!==0||s('No resource defined. Define a resource first with o("YourResourcePath").'),r="",ut&&(r=u.oConfig.endpoint+(bt(u.oConfig.endpoint,"/")?"":"/")),i=0;i<t.path.length;i++)r+=t.path[i].resource,t.path[i].get&&(r+="("+(d[t.path[i].get]||t.path[i].get)+")"),r+="/";return r+t.appending+ni()}function ni(){var n="";for(queryName in f.query)f.query.hasOwnProperty(queryName)&&f.query[queryName]!=null&&(n+="&"+f.queryList[f.query[queryName]].name+"="+hi(f.queryList[f.query[queryName]].value,d));return n.length>0?"?"+n.substring(1):""}function lt(n){for(var r,f,t,i=0;i<v.length;i++)if(v[i].route.regex.test(n)){if(d={},r={},f=v[i].route.regex.exec(n),typeof v[i].route.param!="undefined"){t=1;for(prop in v[i].route.param)d[prop]=f[t],r[prop.substring(1)]=f[t],t++}else for(t=1;t<f.length;t++)d[":"+(t-1)]=f[t],r[t-1]=f[t];st(r)||ri(v[i].callback,r);u.param=r}}function ti(n){var u=n,t,r,i;if(!(n instanceof RegExp)){for(oConfig.isHashRoute&&!rt(n,"#")&&(n="#"+n),t=n.split("/"),r={},i=0;i<t.length;i++)rt(t[i],":")&&(r[t[i]]=!0,t[i]="([\\w| |-]+|\\[W| |-]+)");u=new RegExp("^"+t.join("/")+"$")}return{regex:u,param:r}}function ii(n){if(JSON)return JSON.parse(JSON.stringify(n));s("No JSON Support.")}function at(n){var r=new RegExp("'.*?'",""),i=r.exec(n),t;n=n.replace(r,"{0}");for(key in y)n=n.split(key).join(" "+y[key]+" ");if(i!=null)for(t=0;t<i.length;t++)n=n.replace("{0}",i[t]);return n}function w(n){f&&e.push(f);f=typeof n=="string"?ft(n):n;for(var t=0;t<oConfig.appending.length;t++)o(oConfig.appending[t].name,oConfig.appending[t].value)}function g(n,t,i,r){var l,h,c,o;if(f===null&&s('You must define a resource to perform a get(), post(), put() or delete() function. Define a resource with o("YourODataResource").'),e.length!==0||i)if(e.push(f),l=ot(f.method,a()),oi(["POST","PATCH","DELETE"])<=1&&i&&!k)et(l,wt(f.data),n,t,!1,[{name:"Accept",value:"application/json"},{name:"Content-Type",value:"application/json"}],r,e[e.length-1].progress),pt(["POST","PATCH","DELETE"]);else{for(h=yt(),c=u.oConfig.endpoint+(bt(u.oConfig.endpoint,"/")?"":"/")+"$batch",o=0;o<oConfig.appending.length;o++)c+=(o===0?"?":"&")+oConfig.appending[o].name+"="+oConfig.appending[o].value;et(ot("POST",c),si(h,i),n,t,!0,[{name:"Content-Type",value:"multipart/mixed; boundary=batch_"+h}],r,e[e.length-1].progress);i&&pt(["POST","PUT","DELETE"])}else et(ot("GET",a()),null,n,t,!1,null,r,f.progress)}function ri(n,t){f.path[0].resource!==""?g(n,null,!1,t):n.call(u,t)}function ui(n){return typeof n=="undefined"?u:(n.toUpperCase().indexOf("HTTP://")>-1||n.toUpperCase().indexOf("HTTPS://")>-1?ut=!1:u.oConfig.endpoint||s("You can not use resource query without defining your oData endpoint. Use o().config({endpoint:youeEndpoint}) to define your oData endpoint."),routeName=n,w(n),u)}function fi(n){nt("$expand")?(f.queryList[f.query.$expand].value+=","+n,f.queryList[f.query.$expand].original=f.queryList[f.query.$expand].value):o("$expand",n,n)}function ft(n){var e=n.split("?"),s=n,h="",r={path:[],appending:"",query:{},queryList:[],method:"GET",data:null,progress:null},o,f,i,t,u;if(e.length===2)for(s=e[0],h=e[1],o=h.split("&"),t=0;t<o.length;t++)f=o[t].split("="),r.queryList.push({name:f[0],value:f[1]}),r.query[f[0]]=r.queryList.length-1;for(i=s.split("/"),t=0;t<i.length;t++)rt(i[t],"$")&&i[t]!=="$link"?r.appending=i[t]:(u=i[t].split("("),u.length===1||rt(i[t],"(")?r.path.push({resource:i[t],get:null}):r.path.push({resource:u[0],get:u[1].substring(0,u[1].length-1)}));return r}function o(n,t,i,r){i=i||null;f.queryList.push({name:n,value:t,original:i});f.query[r||n]=f.queryList.length-1}function vt(n,t,i,r,u){i=i||null;r=r||" or ";n=u||n;f.queryList[f.query[n]].value="("+f.queryList[f.query[n]].value+")"+r+"("+t+")";i&&(f.queryList[f.query[n]].original=f.queryList[f.query[n]].value)}function tt(n){f.query[n]=null}function c(n){if(nt(n)){var t=n;return it(t)&&(t=t.join(",")),s("There is already a depending query. You can not use them together/twice: "+t),!0}return!1}function nt(n){for(var i=it(n)?n:[n],r=!1,t=0;t<i.length;t++)f.query.hasOwnProperty(i[t])&&(r=!0);return r}function yt(){var n=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=(n+Math.random()*16)%16|0;return n=Math.floor(n/16),(t=="x"?i:i&7|8).toString(16)})}function b(n,t){if(typeof n!="undefined"&&n!==null&&n.length>0)return n;s(t+": Parameter must be set.")}function ei(n,t){if(typeof n=="number")return n;var i=t;return n&&n.length>0&&(isNaN(n)||(i=parseInt(n))),i}function oi(n){for(var i=0,t=0;t<e.length;t++)n.indexOf(e[t].method)>-1&&i++;return i}function pt(n){for(var i=[],t=0;t<e.length;t++)n.indexOf(e[t].method)>-1&&i.push(t);for(t=i.length-1;t>=0;t--)e.splice(i[t],1);e[0]&&(f=e[0])}function wt(n){return JSON?JSON.stringify(n):(s("No JSON support."),n)}function it(n){return typeof Array.isArray=="undefined"?n.toString()==="[object Array]":Array.isArray(n)}function bt(n,t){return n?n.indexOf(t,n.length-t.length)!==-1:!1}function rt(n,t){return n.indexOf(t)===0}function s(n){function t(n){this.message=n;this.name="o.js exception"}if(t.prototype=new Error,u.oConfig.strictMode===!0)throw new t(n);else console.log("o.js exception: "+n)}function si(n,t){var i="",s=yt(),h=!1,o,r;for(t&&(i+="--batch_"+n+"\n",i+="Content-Type: multipart/mixed; boundary=changeset_"+s+"\n\n"),o=0;o<e.length;o++)r=e[o],f=r,r.method!=="GET"||t?(r.method==="POST"||r.method==="PUT"||r.method==="PATCH"||r.method==="DELETE")&&t&&(i+="--changeset_"+s+"\n",i+="Content-Type: application/http\n",i+="Content-Transfer-Encoding: binary\n",i+="Content-ID:"+o+1+"\n\n",i+=r.method+" "+a(r)+" HTTP/1.1\n",i+="Host: "+u.oConfig.endpoint+"\n",i+="Content-Type: application/json\n",i+=wt(f.data)+"\n\n\n",h=!0):(i+="--batch_"+n+"\n",i+="Content-Type: application/http\n",i+="Content-Transfer-Encoding: binary\n\n",i+=r.method+" "+a(r)+" HTTP/1.1\n",i+="Host: "+u.oConfig.endpoint+"\n\n");return h&&(i+="--changeset_"+s+"--\n\n"),i+("--batch_"+n+"--")}function et(n,t,i,r,f,e,o,c){var v,y;if(u.oConfig.start&&h==null&&(u.oConfig.openAjaxRequests++,u.oConfig.start()),h&&h[0]&&h[0](!0),v=u,k?(n.onload=function(){n.readyState=4;n.status=200;n.onreadystatechange()},n.onerror=function(){n.readyState=0;n.status=400;n.onreadystatechange()}):typeof c=="function"&&(n.onprogress=c),n.onreadystatechange=function(){var h,c,u,t,y;if(n.readyState===4){if(n.status>=200&&n.status<300){if(n.status!==204)if(f){h=[];c=/({[\s\S]*?--batchresponse_)/g;do u=c.exec(n.responseText),u&&(dt(u[0].substring(0,u[0].length-16),v),h.push(v.data));while(u);v.data=h}else dt(n.responseText,v);l&&l.resolve(v);typeof i=="function"&&i.call(v,v.data,o)}else try{t=n.responseText;JSON&&n.responseText!=""&&(t=JSON.parse(n.responseText));t!==""&&t["odata.error"]?(y=t["odata.error"].message.value+" | HTTP Status: "+n.status+" | oData Code: "+t["odata.error"].code,s(y)):s("Request to "+a()+" failed with HTTP status "+(n.status||404)+".")}catch(e){if(kt(v,!0,n.status||404,n.responseText),typeof r=="function")r(n.status||404,e);else if(l)e.status=n.status||404,l.reject(e);else throw e;}kt(v,!1)}},u.oConfig.username&&u.oConfig.password&&(k&&s("CORS and Basic Auth is not supported for IE <= 9. Try to set isCors:false in the OData config if you do not need CORS support."),n.setRequestHeader("Authorization","Basic "+ci(u.oConfig.username+":"+u.oConfig.password))),!k){if(e)for(y=0;y<e.length;y++)n.setRequestHeader(e[y].name,e[y].value);if(u.oConfig.headers.length>0)for(y=0;y<u.oConfig.headers.length;y++)n.setRequestHeader(u.oConfig.headers[y].name,u.oConfig.headers[y].value)}n.send(t)}function kt(n,t,i,r){n.oConfig.ready&&h==null&&(n.oConfig.openAjaxRequests--,n.oConfig.openAjaxRequests<=0&&n.oConfig.ready());h&&h[1]&&h[1](!1);n.oConfig.error&&t&&n.oConfig.error(i,r)}function dt(n,t){var r=ei(n,-1),i;r!==-1?t.data=r:JSON?(i=JSON.parse(n),t.raw=i,i.hasOwnProperty("value")?(t.data=nt(["$first"])&&i.value.length&&i.value.length<=1?i.value[0]:i.value,(i.hasOwnProperty("odata.count")||i.hasOwnProperty("@odata.count"))&&(t.inlinecount=i["odata.count"]||i["@odata.count"])):t.data=i,f.data=t.data):t.data=n}function ot(n,t){var i=null,r;return typeof window=="undefined"?(r=require("xhr2"),i=new r):i=typeof XMLHttpRequest!="undefined"?new XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0"),u.oConfig.isCors&&"withCredentials"in i?i.open(n,t,u.oConfig.isAsync):u.oConfig.isCors&&typeof XDomainRequest!="undefined"?(i=new XDomainRequest,k=!0,n=="GET"?i.open(n,t):i.open("POST",t)):i.open(n,t,u.oConfig.isAsync),i}function hi(){var n=arguments[0],t=arguments[1],i;for(p in t)i=new RegExp(p,"g"),typeof n=="string"&&(n=n.replace(i,t[p]));return n}function ci(n){var t={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(n){var e="",o,i,r,h,c,s,u,f=0;for(n=t._utf8_encode(n);f<n.length;)o=n.charCodeAt(f++),i=n.charCodeAt(f++),r=n.charCodeAt(f++),h=o>>2,c=(o&3)<<4|i>>4,s=(i&15)<<2|r>>6,u=r&63,isNaN(i)?s=u=64:isNaN(r)&&(u=64),e=e+this._keyStr.charAt(h)+this._keyStr.charAt(c)+this._keyStr.charAt(s)+this._keyStr.charAt(u);return e},_utf8_encode:function(n){var i,r,t;for(n=n.replace(/\r\n/g,"\n"),i="",r=0;r<n.length;r++)t=n.charCodeAt(r),t<128?i+=String.fromCharCode(t):t>127&&t<2048?(i+=String.fromCharCode(t>>6|192),i+=String.fromCharCode(t&63|128)):(i+=String.fromCharCode(t>>12|224),i+=String.fromCharCode(t>>6&63|128),i+=String.fromCharCode(t&63|128));return i}};return t.encode(n)}var u=this,f=null,e=[],v=[],ut=!0,l=null,h=null,k=!1,st=function(){},d={},y={"==":"eq","===":"eq","!=":"ne","!==":"ne",">":"gt",">=":"ge","<":"lt","<=":"le","&&":"and","||":"or","!":"not","*":"mul","%":"mod"};return u.data=[],u.raw=null,u.inlinecount=null,u.param={},u.oConfig=r,u.routes=u.route=function(n,t){var r,i;for(it(n)||(n=[n]),typeof window=="undefined"&&s("Routes are only supported in a browser env."),r=window.location.hash,i=0;i<n.length;i++)typeof t!="undefined"?v.push({name:n[i],route:ti(n[i]),callback:t,param:{},interval:setInterval(function(){window.location.hash!=r&&(r=window.location.hash,lt(window.location.hash))},100)}):s('Routes without a callback are not supported. Please define a function like .route("YourRoute", function() { }).');return u.triggerRoute(window.location.hash),u},u.beforeRouting=function(n){return st=n,u},u.isEndpoint=function(){return ut},u.triggerRoute=function(n){return lt(n),u},u.find=function(n){return f.path[f.path.length-1].get=n,u},u.top=u.take=function(n){return c(["$top"])||o("$top",n,n),u},u.skip=function(n){return c("$skip")||o("$skip",n,n),u},u.first=function(){return c(["$top","$first"])||o("$top",1,null,"$first"),u},u.filter=u.where=function(n){var t=b(at(n));return nt("$filter")?vt("$filter",t,t):o("$filter",t,t),u},u.any=function(n,t){var i=n+"/any(x:x/"+at(b(t))+")";return nt("$filter")?vt("$filter",i,i):o("$filter",i,i),u},u.orderBy=function(n,t){return typeof t=="undefined"&&(t="asc"),c("$orderby")||o("$orderby",b(n)+" "+t),u},u.orderByDesc=function(n){return u.orderBy(n,"desc")},u.select=function(n){return o("$select",b(n)),u},u.count=function(){return tt("$format"),f.appending="$count",u},u.inlineCount=function(n){return oConfig.version==4?(n=n||"true",c("$count")||o("$count",n)):(n=n||"allpages",c("$inlinecount")||o("$inlinecount",n)),u},u.batch=function(n){return w(n),u},u.expand=function(n){return fi(n),u},u.loading=function(n,t){return t=t||n,h=n?[n,t]:[function(){},function(){}],u},u.ref=u.link=function(n,t){var i,r;return tt("$format"),(f==null||f.get)&&s("You need to define a resource with the find() method to append an navigation property"),oConfig.version<4?(f.method="POST",f.path.push("$link"),f.path.push({resource:n,get:null})):(f.method="POST",f.path.push({resource:n,get:null}),f.appending="$ref"),i=ft(n),i.path[i.path.length-1].get=t,r=a(i),f.data={"@odata.id":r.substring(0,r.length-1)},u},u.removeRef=u.deleteRef=function(n,t){var i,r;return tt("$format"),(f==null||f.get)&&s("You need to define a resource with the find() method to append an navigation property"),oConfig.version<4?(f.method="POST",f.path.push("$link"),f.path.push({resource:n,get:null})):(f.method="POST",f.path.push({resource:n,get:null}),f.appending="$ref"),t&&(i=ft(n),i.path[i.path.length-1].get=t,r=a(i),o("$id",r.substring(0,r.length-1))),f.method="DELETE",u},u.get=function(n,t){var i=ht();return i&&typeof n=="undefined"?(l=i.defer(),g(n,t,!1),l.promise):(g(n,t,!1),u)},u.save=function(n,t){var i,r;return f.method==="GET"&&f.data!==null&&(i=ii(f),i.method="PATCH",i.data=f.data,w(i)),r=ht(),r&&typeof n=="undefined"?(l=r.defer(),g(n,t,!0),l.promise):(g(n,t,!0),u)},u.post=function(n,t){return tt("$format"),t&&w(t),f.method="POST",f.data=n,u},u.patch=u.put=function(n,t){return t&&w(t),f.path[f.path.length-1]&&f.path[f.path.length-1].get||s("Bulk updates are not supported. You need to query a unique resource with find() to patch/put it."),f.method="PATCH",f.data=n,u},u.remove=u["delete"]=function(n){return n&&w(n),f.path[f.path.length-1]&&f.path[f.path.length-1].get||s("Bulk deletes are not supported. You need to query a unique resource with find() to delete it."),f.method="DELETE",u},u.query=function(n){return a(n)},u.search=function(n,t,i,r){var f=gt(n,t,i);return oConfig.version==4&&r?c("$search")||o("$search",f,f):c("$filter")||o("$filter",f,f,"$search"),u},u.filterByList=u.exclude=function(n,t){if(!c("$filter")){var i=ct(n,t,y["!="],y["&&"]);o("$filter",b(i),i)}return u},u.include=function(n,t){if(!c("$filter")){var i=ct(n,t,y["=="],y["||"]);o("$filter",b(i),i)}return u},u.progress=function(n){return f!=null&&(f.progress=n),u},ui(t)}return t});